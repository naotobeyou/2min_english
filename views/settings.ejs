<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>è¨­å®š | 2min English</title>
  <link rel="stylesheet" href="/css/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

  <div class="card" style="max-width: 500px; margin: 4rem auto;">
    <h2 class="text-center">âš™ï¸ è¨­å®š</h2>
    <p class="text-center text-sm" style="margin-bottom: 1rem;">ã‚ˆã†ã“ãã€<strong><%= user.username %></strong> ã•ã‚“</p>

    <h3>ğŸ§ éŸ³å£°ãƒ‡ãƒã‚¤ã‚¹è¨­å®š</h3>

    <label for="micSelect">ğŸ¤ ãƒã‚¤ã‚¯:</label>
    <select id="micSelect" class="input" style="margin-bottom: 1rem;"></select>

    <label for="speakerSelect">ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼:</label>
    <select id="speakerSelect" class="input" style="margin-bottom: 1rem;"></select>

    <p id="deviceInfo" class="text-sm" style="color: gray; margin-top: 0.5rem;"></p>

    <a href="/dashboard" class="btn btn-secondary" style="margin-top: 1.5rem;">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹</a>
  </div>

  <script>
    const micSelect = document.getElementById('micSelect');
    const speakerSelect = document.getElementById('speakerSelect');
    const deviceInfo = document.getElementById('deviceInfo');

    async function loadAudioDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const audioInputs = devices.filter(d => d.kind === 'audioinput');
        const audioOutputs = devices.filter(d => d.kind === 'audiooutput');

        micSelect.innerHTML = '';
        speakerSelect.innerHTML = '';

        audioInputs.forEach(device => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.textContent = device.label || `ãƒã‚¤ã‚¯ (${device.deviceId})`;
          micSelect.appendChild(option);
        });

        audioOutputs.forEach(device => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.textContent = device.label || `ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ (${device.deviceId})`;
          speakerSelect.appendChild(option);
        });

        const savedMic = localStorage.getItem('preferredMic');
        const savedSpeaker = localStorage.getItem('preferredSpeaker');

        if (savedMic && micSelect.querySelector(`[value="${savedMic}"]`)) {
          micSelect.value = savedMic;
        }

        if (savedSpeaker && speakerSelect.querySelector(`[value="${savedSpeaker}"]`)) {
          speakerSelect.value = savedSpeaker;
        }

        deviceInfo.textContent = 'ã“ã®è¨­å®šã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚';
      } catch (err) {
        console.error('ğŸ¤ ãƒ‡ãƒã‚¤ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        deviceInfo.textContent = 'ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    }

    micSelect.addEventListener('change', () => {
      localStorage.setItem('preferredMic', micSelect.value);
    });

    speakerSelect.addEventListener('change', () => {
      localStorage.setItem('preferredSpeaker', speakerSelect.value);
    });

    loadAudioDevices();
  </script>
</body>
</html>
