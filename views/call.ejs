<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°é€šè©±</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <!-- é€šè©±ãƒ«ãƒ¼ãƒ æƒ…å ± -->
  <div class="card text-center" style="max-width: 800px; margin: 2rem auto;">
    <h1 class="text-lg">ğŸ—£ï¸ é€šè©±ãƒ«ãƒ¼ãƒ : <%= roomId %></h1>
    <p id="status">éŸ³å£°é€šè©±ã‚’æº–å‚™ä¸­...</p>

    <div id="timer" class="timer">02:00</div>
    <p id="extensionInfo" class="text-sm">å»¶é•·å¯èƒ½å›æ•°: 2å›</p>
    <button id="extendBtn" class="btn btn-secondary" style="display: none;">å»¶é•·ã™ã‚‹</button>
  </div>

  <!-- ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
  <div class="card" style="max-width: 800px; margin: 2rem auto;">
    <h2>ğŸ‘¤ ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>
    <img src="/uploads/<%= partner.avatar || 'default.png' %>" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" class="avatar" style="width: 120px; height: 120px; margin-bottom: 1rem;">
    <ul style="list-style: none; padding: 0;">
      <li><strong>åå‰:</strong> <%= partner.username %></li>
      <li><strong>è¶£å‘³:</strong> <%= partner.hobbies || 'æœªè¨­å®š' %></li>
      <li><strong>ç›®çš„:</strong> <%= partner.purpose || 'æœªè¨­å®š' %></li>
      <li><strong>è‹±èªãƒ¬ãƒ™ãƒ«:</strong> <%= partner.level %></li>
    </ul>
  </div>

  <!-- è©±é¡Œã‚«ãƒ¼ãƒ‰ -->
  <div class="card" style="max-width: 800px; margin: 2rem auto;" id="topicCardArea">
    <h3>ğŸ’¬ è©±é¡Œã‚«ãƒ¼ãƒ‰</h3>
    <select id="topicSelect" class="input">
      <option value="">-- è©±é¡Œã‚’é¸ã‚“ã§ãã ã•ã„ --</option>
      <option value="é€±æœ«ã¯ä½•ã‚’ã—ã¦éã”ã™ã®ãŒå¥½ãï¼Ÿ">é€±æœ«ã¯ä½•ã‚’ã—ã¦éã”ã™ã®ãŒå¥½ãï¼Ÿ</option>
      <option value="æœ€è¿‘è¦‹ãŸæ˜ ç”»ã§é¢ç™½ã‹ã£ãŸã®ã¯ï¼Ÿ">æœ€è¿‘è¦‹ãŸæ˜ ç”»ã§é¢ç™½ã‹ã£ãŸã®ã¯ï¼Ÿ</option>
      <option value="è‹±èªã‚’å­¦ã¶ãã£ã‹ã‘ã¯ï¼Ÿ">è‹±èªã‚’å­¦ã¶ãã£ã‹ã‘ã¯ï¼Ÿ</option>
      <option value="ã‚‚ã—ã©ã“ã§ã‚‚ä½ã‚ã‚‹ãªã‚‰ã€ã©ã“ã‚’é¸ã¶ï¼Ÿ">ã‚‚ã—ã©ã“ã§ã‚‚ä½ã‚ã‚‹ãªã‚‰ã€ã©ã“ã‚’é¸ã¶ï¼Ÿ</option>
      <option value="å­ã©ã‚‚ã®ã“ã‚ã®å¤¢ã¯ï¼Ÿ">å­ã©ã‚‚ã®ã“ã‚ã®å¤¢ã¯ï¼Ÿ</option>
    </select>
    <button id="sendTopicBtn" class="btn btn-secondary" style="margin-top: 0.5rem;">ã“ã®è©±é¡Œã«ã™ã‚‹</button>
    <p id="topicDisplay" class="text-lg" style="margin-top: 1rem; font-weight: bold;"></p>
    <p id="topicNotice" class="text-sm" style="color: gray; margin-top: 0.5rem;"></p>
  </div>

  <!-- ä¸€æ™‚åœæ­¢ãƒ»çµ‚äº†ãƒœã‚¿ãƒ³ -->
  <div class="text-center" style="margin-top: 1rem;">
    <button id="pauseBtn" class="btn btn-secondary">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
    <p id="pauseHint" style="color: gray; margin-top: 5px;">â†‘èª¿ã¹ã‚‚ã®ã‚’ã™ã‚‹ã¨ãã«ä½¿ã£ã¦ã­ï¼</p>
    <button id="resumeBtn" class="btn btn-secondary" style="display:none;">â–¶ï¸ å†é–‹</button>
    <button id="endCallBtn" class="btn btn-primary" style="background-color: crimson;" disabled>é€šè©±ã‚’çµ‚äº†ã™ã‚‹</button>

  </div>

  <!-- æ®‹ã‚Šæ™‚é–“è¡¨ç¤º -->
  <div class="text-center" style="margin-top: 1rem;">
    <div id="pause-status" style="display: none;">
      <span id="pause-label" style="font-size: 1.2em;"></span>
    </div>
    <p id="myPauseTime">â¸ï¸ ã‚ãªãŸã®æ®‹ã‚Š: <span id="myPauseTimeLeft">2:00</span></p>
    <p id="partnerPauseTime">â¸ï¸ ç›¸æ‰‹ã®æ®‹ã‚Š: <span id="partnerPauseTimeLeft">2:00</span></p>
  </div>

  <!-- ğŸ§ ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆ -->
  <div class="card" style="max-width: 800px; margin: 2rem auto;">
    <h3>ğŸ§ ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆ</h3>
    <label for="micSelect">ğŸ¤ ãƒã‚¤ã‚¯:</label>
    <select id="micSelect" class="input"></select>

    <label for="speakerSelect" style="margin-top: 1rem;">ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼:</label>
    <select id="speakerSelect" class="input"></select>

    <div id="speakerVolumeControl" style="margin-top: 1rem;">
      <label for="speakerVolume">ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼éŸ³é‡:</label>
      <input type="range" id="speakerVolume" min="0" max="1" step="0.01" value="1">
    </div>

    <p class="text-sm" style="color: gray;">ãƒã‚¤ã‚¯ãƒ»ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ã¯é€šè©±ä¸­ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã§ã™</p>
  </div>

  <!-- ãƒ¡ãƒ¢ãƒ»é€šå ±ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆéè¡¨ç¤ºï¼‰ -->
  <div id="noteSection" class="card" style="display: none; max-width: 800px; margin: 2rem auto;">
    <h3>ğŸ“ é€šè©±ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h3>
    <form id="noteForm" method="POST" action="/save-note">
      <textarea name="note" rows="5" class="input" placeholder="æ°—ã¥ãã‚„æ”¹å–„ç‚¹ãªã©ã‚’æ›¸ã„ã¦ã­ï¼"></textarea><br>
      <input type="hidden" name="roomId" value="<%= roomId %>">
      <input type="hidden" name="partnerId" value="<%= partner._id %>">
      <button type="submit" class="btn btn-primary" style="margin-top: 0.5rem;">ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹</button>
    </form>
    <button id="skipNoteBtn" class="btn btn-secondary" style="margin-top: 10px;">ãƒ¡ãƒ¢ã‚’æ®‹ã•ãšçµ‚äº†</button>

   <form id="blockForm" method="POST" action="/block" onsubmit="return confirm('æœ¬å½“ã«ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™ã‹ï¼Ÿ')">
      <input type="hidden" name="blockedUserId" value="<%= partner._id %>">

      <label for="reason">é€šå ±ç†ç”±:</label>
      <select name="reason" id="reason" class="input" required>
        <option value="" disabled selected>é¸ã‚“ã§ãã ã•ã„</option>
        <option value="è¿·æƒ‘è¡Œç‚º">è¿·æƒ‘è¡Œç‚º</option>
        <option value="ä¸é©åˆ‡ãªè¨€è‘‰ã¥ã‹ã„">ä¸é©åˆ‡ãªè¨€è‘‰ã¥ã‹ã„</option>
        <option value="æ€§çš„ãªç™ºè¨€">æ€§çš„ãªç™ºè¨€</option>
        <option value="æš´åŠ›çš„ãªç™ºè¨€">æš´åŠ›çš„ãªç™ºè¨€</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select><br>

      <label for="details">è©³ç´°ãªç†ç”±ï¼ˆä»»æ„ï¼‰:</label>
      <textarea name="details" rows="3" class="input" placeholder="è£œè¶³ãŒã‚ã‚Œã°æ›¸ã„ã¦ãã ã•ã„"></textarea><br>

      <button type="submit" class="btn btn-secondary" style="color: red; margin-top: 0.5rem;">ğŸš« é€šå ±ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹</button>
    </form>

    

  </div>

  <!-- éŸ³å£°å‡ºåŠ› -->
  <audio id="remoteAudio" autoplay></audio>

  <!-- Socket.IO + JavaScript -->
  <script src="/socket.io/socket.io.js"></script>

  <script>

    window.addEventListener('DOMContentLoaded', () => {
      const blockForm = document.getElementById('blockForm');
      if (blockForm) blockForm.style.display = 'none';
    });

    
    const socket = io();
    const roomId = "<%= roomId %>";
    const userId = "<%= user._id %>";
  
    socket.emit('join-waiting', userId);
  
    const peer = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
  
    const endCallBtn = document.getElementById('endCallBtn');
    const timerDisplay = document.getElementById('timer');
    const noteSection = document.getElementById('noteSection');
    const statusEl = document.getElementById('status');
    const extendBtn = document.getElementById('extendBtn');
    const pauseHint = document.getElementById('pauseHint');

  
    let remaining = 120;
    let timerInterval;
    
  
  
    
    function endCall() {
      
      // è¡¨ç¤ºã‚’éè¡¨ç¤ºã«
      if (statusEl) statusEl.style.display = 'none';
      if (endCallBtn) endCallBtn.style.display = 'none';
      if (timerDisplay) timerDisplay.style.display = 'none';
      if (noteSection) noteSection.style.display = 'block';
      if (pauseHint) pauseHint.remove();  
      if (blockForm) blockForm.style.display = 'block';
  

      clearInterval(timerInterval);


      [
      'extensionInfo',
      'extendBtn',
      'topicCardArea',
      'pauseBtn',
      'resumeBtn',
      'myPauseTime',
      'partnerPauseTime',
      'pause-status',
      'micSelect',
      'speakerSelect',
      'speakerVolumeControl',
    ].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });


    // ğŸ§ ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆé–¢é€£ã®ãƒ©ãƒ™ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚‚éè¡¨ç¤ºã«
    const micLabel = document.querySelector('label[for="micSelect"]');
    const speakerLabel = document.querySelector('label[for="speakerSelect"]');

    // ğŸ‘‡ ã™ã¹ã¦ã® <p> ã‚’ç¢ºèªã—ã€ç›®çš„ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€ã‚‚ã®ã‚’éè¡¨ç¤ºã«
    const allParagraphs = document.querySelectorAll('p');
    allParagraphs.forEach(p => {
      if (p.textContent.includes('ãƒã‚¤ã‚¯ãƒ»ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼')) {
        p.style.display = 'none';
      }
    });

    if (micLabel) micLabel.style.display = 'none';
    if (speakerLabel) speakerLabel.style.display = 'none';

    // ğŸ§ ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒˆãƒ«ã‚‚éè¡¨ç¤º
    const deviceHeading = Array.from(document.getElementsByTagName('h3'))
      .find(h => h.textContent.includes('ãƒ‡ãƒã‚¤ã‚¹åˆ‡ã‚Šæ›¿ãˆ'));
    if (deviceHeading) deviceHeading.style.display = 'none';


  
      // éŸ³å£°é€ä¿¡åœæ­¢
      if (peer && peer.getSenders) {
        peer.getSenders().forEach(sender => {
          if (sender.track) sender.track.stop();
        });
      }

      socket.emit('force-end', roomId);

      fetch('/mark-ended', { method: 'POST' });
    }


  
    endCallBtn.addEventListener('click', endCall);

    let timerPaused = false; 
  
    function startTimer() {
      timerInterval = setInterval(() => {
        if (timerPaused) return;  // â¸ï¸ ä¸€æ™‚åœæ­¢ä¸­ã¯ä½•ã‚‚ã—ãªã„

        const min = String(Math.floor(remaining / 60)).padStart(2, '0');
        const sec = String(remaining % 60).padStart(2, '0');
        timerDisplay.textContent = `${min}:${sec}`;

        if (remaining === 30 && extensionCount < 2) {
          timerDisplay.style.color = "red";
          extendBtn.style.display = 'inline-block';
          extendBtn.disabled = false;
          extendBtn.textContent = 'å»¶é•·ã™ã‚‹';
        }

        if (remaining <= 0) {
          clearInterval(timerInterval);
          if (statusEl) {
            statusEl.textContent = 'ğŸ“ é€šè©±æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã—ã‚‡ã†ï¼';
            statusEl.style.color = 'black';
          }
          endCall();
        }

        remaining--;
      }, 1000);
    }
      
    socket.on('matched', (roomId) => {
      window.location.href = `/call/${roomId}`;
    });
  
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        stream.getTracks().forEach(track => peer.addTrack(track, stream));
  
        peer.ontrack = (event) => {
          document.getElementById('remoteAudio').srcObject = event.streams[0];
          if (statusEl) {
            statusEl.textContent = 'âœ… é€šè©±ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼';
            statusEl.style.color = 'green';
            statusEl.style.fontWeight = 'bold';
          }

      
          endCallBtn.disabled = false;
          startTimer();
        };
  
        socket.emit('join-room', roomId);
  
        socket.on('ready', async () => {
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit('offer', roomId, offer);
        });
  
        socket.on('offer', async (offer) => {
          await peer.setRemoteDescription(offer);
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        });
  
        socket.on('answer', async (answer) => {
          await peer.setRemoteDescription(answer);
        });
  
        socket.on('ice-candidate', async (candidate) => {
          if (candidate) {
            await peer.addIceCandidate(candidate);
          }
        });

        socket.on('force-end', () => {
            console.log("ğŸ“´ ç›¸æ‰‹ãŒé€šè©±ã‚’çµ‚äº†ã—ãŸãŸã‚ã€è‡ªåˆ†ã‚‚çµ‚äº†ã—ã¾ã™");
            endCall(); // è‡ªåˆ†å´ã§ã‚‚çµ‚äº†å‡¦ç†
        });
  
        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('ice-candidate', roomId, event.candidate);
          }
        };
      })
      .catch(err => {
        console.error("âŒ ãƒã‚¤ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      });



      const topicSelect = document.getElementById('topicSelect');
      const sendTopicBtn = document.getElementById('sendTopicBtn');
      const topicDisplay = document.getElementById('topicDisplay');
      let topicLock = false;

      sendTopicBtn.addEventListener('click', () => {
        const selectedTopic = topicSelect.value;
        if (!selectedTopic || topicLock) return;

        socket.emit('topic-selected', { roomId, topic: selectedTopic });
        topicDisplay.textContent = `ğŸ’¬ è©±é¡Œ: ${selectedTopic}`;
        topicNotice.textContent = `ãƒˆãƒ”ãƒƒã‚¯ã®å†é¸æŠã¯30ç§’å¾Œã«å¯èƒ½ã«ãªã‚Šã¾ã™ï¼`;
        startTopicCountdownNotice(); 
        lockTopicSelection();

        setTimeout(() => {
          topicNotice.textContent = '';
        }, 30000);
      });

      // ç›¸æ‰‹ã‹ã‚‰å±Šã„ãŸè©±é¡Œã‚‚è¡¨ç¤º
      socket.on('topic-selected', (topic) => {
        topicDisplay.textContent = `ğŸ’¬ è©±é¡Œ: ${topic}`;
        if (!topicLock) {
          lockTopicSelection();
          startTopicCountdownNotice('é€šè©±ç›¸æ‰‹ãŒä»¥ä¸‹ã®ãƒˆãƒ”ãƒƒã‚¯ã‚’é¸ã³ã¾ã—ãŸï¼<br>');
        }
      });



      // é¸æŠå¾Œ30ç§’é–“ãƒ­ãƒƒã‚¯
      function lockTopicSelection() {
        topicLock = true;
        sendTopicBtn.disabled = true;
        topicSelect.disabled = true;
        setTimeout(() => {
          topicLock = false;
          sendTopicBtn.disabled = false;
          topicSelect.disabled = false;
        }, 30000); // 30ç§’å¾Œã«è§£é™¤
      }

      function startTopicCountdownNotice(prefix = '') {
        let secondsLeft = 30;
        topicNotice.innerHTML = `
          ${prefix}ãƒˆãƒ”ãƒƒã‚¯ã®å†é¸æŠã¯ ${secondsLeft} ç§’å¾Œã«å¯èƒ½ã§ã™ã€‚
        `;
        const topicTimer = setInterval(() => {
          secondsLeft--;
          if (secondsLeft <= 0) {
            clearInterval(topicTimer);
            topicNotice.textContent = '';
          } else {
            topicNotice.innerHTML = `
              ${prefix}ãƒˆãƒ”ãƒƒã‚¯ã®å†é¸æŠã¯ ${secondsLeft} ç§’å¾Œã«å¯èƒ½ã§ã™ã€‚
            `;
          }
        }, 1000);
      }
              

        // å»¶é•·å‡¦ç†ï¼ˆ60ç§’è¿½åŠ ï¼‰
        let extensionCount = 0; // â† è¿½åŠ ï¼ˆåˆè¨ˆå»¶é•·å›æ•°ã‚’ç®¡ç†ï¼‰
        let isExtending = false;

        function extendCall() {

            isExtending = true;
            console.log("ğŸŸ© extendCall() å®Ÿè¡Œï¼ ç¾åœ¨ã® extensionCount:", extensionCount);

            extensionCount++;
            remaining += 60;

            updateExtensionInfo(); 

            // extensionCount ãŒ 2 ã«é”ã—ãŸã¨ãã ã‘éè¡¨ç¤ºã«ã™ã‚‹
            if (extensionCount >= 2) {
                extendBtn.style.display = 'none';
            } else {
                extendBtn.style.display = 'inline-block';
                extendBtn.disabled = true;
                extendBtn.textContent = 'ç›¸æ‰‹ã®åŒæ„ã‚’å¾…ã£ã¦ã„ã¾ã™...';
            }


            statusEl.textContent = 'âœ… é€šè©±ãŒ1åˆ†å»¶é•·ã•ã‚Œã¾ã—ãŸ';
            statusEl.style.color = 'green';


            extensionRequested = false;
            extensionReceived = false;

            setTimeout(() => {
                isExtending = false;
            }, 100);
        }

      document.getElementById('skipNoteBtn').addEventListener('click', () => {
        if (confirm("ãƒ¡ãƒ¢ã‚’æ®‹ã•ãšçµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) {
            window.location.href = '/dashboard';
        }
        });

          //å»¶é•·æ©Ÿèƒ½
        let extensionAgreed = false;
        let partnerAgreed = false;



        let extensionRequested = false;
        let extensionReceived = false;

        extendBtn.addEventListener('click', () => {
            if (extensionCount >= 2) return;

            // ğŸ§¹ ã“ã“ã§æ¯å›åˆæœŸåŒ–ï¼ˆå¤§äº‹ï¼ï¼‰
            extensionRequested = true;
            extensionReceived = false;

            extendBtn.disabled = true;
            extendBtn.textContent = 'ç›¸æ‰‹ã®åŒæ„ã‚’å¾…ã£ã¦ã„ã¾ã™...';

            socket.emit('request-extension', roomId);

        if (extensionReceived) {
            socket.emit('approve-extension', roomId); // ä¸¡æ–¹æŠ¼ã—ãŸã®ã§OKé€šçŸ¥
            extendCall();
        }
        });


        // ç›¸æ‰‹ã‹ã‚‰å»¶é•·ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šã„ãŸæ™‚
        socket.on('extension-requested', () => {
        extensionReceived = true;


        if (extensionRequested) {
            socket.emit('approve-extension', roomId);
        } else {
            if (extensionCount < 2) {
            extendBtn.style.display = 'inline-block';
            extendBtn.disabled = false;
            extendBtn.textContent = 'é€šè©±ç›¸æ‰‹ãŒå»¶é•·ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™';
            }
        }
        });

        let extensionApprovals = 0;

        socket.on('extension-approved', () => {
        if (extensionApprovals >= extensionCount + 1) return;

        console.log("ğŸ“¥ extension-approved å—ä¿¡ï¼ extensionApprovals:", extensionApprovals, "extensionCount:", extensionCount);
        
        extensionApprovals++;
        extendCall();
        });


         // å»¶é•·å›æ•°è¡¨ç¤ºï¼ˆæœ€å¤§2å›ã¾ã§ï¼‰
        function updateExtensionInfo() {
        const remaining = 2 - extensionCount;
        document.getElementById('extensionInfo').textContent = `å»¶é•·å¯èƒ½å›æ•°: ${remaining}å›`;
        }

        updateExtensionInfo();


        //ä¸€æ™‚åœæ­¢åˆ¶å¾¡
        

        socket.on('pause-time-update', ({ remainingPauseTime }) => {
          const minutes = Math.floor(remainingPauseTime / 60);
          const seconds = remainingPauseTime % 60;
          document.getElementById('partnerPauseTimeLeft').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        });
        
        let isPaused = false;
        let remainingPauseTime = 120; // ç§’æ•°ï¼ˆ2åˆ† = 120ç§’ï¼‰
        let pauseInterval;

        function updatePauseStatusDisplay(userName, isSelfPaused, isOtherPaused) {
          const pauseStatus = document.getElementById('pause-status');
          const pauseLabel = document.getElementById('pause-label');
        

          if (isSelfPaused) {
            pauseLabel.textContent = 'â¸ï¸ ä¸€æ™‚åœæ­¢ä¸­ã§ã™';
            pauseStatus.style.display = 'block';
          } else if (isOtherPaused) {
            pauseLabel.textContent = `â¸ï¸ ${userName}ã•ã‚“ã¯ä»Šä¸€æ™‚åœæ­¢ä¸­ã§ã™`;
            pauseStatus.style.display = 'block';
          } else {
            pauseStatus.style.display = 'none';
          }
        }

        function startPauseCountdown() {
          pauseInterval = setInterval(() => {
            if (remainingPauseTime > 0) {
              remainingPauseTime--;

              const minutes = Math.floor(remainingPauseTime / 60);
              const seconds = remainingPauseTime % 60;

              // âœ… è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è‡ªåˆ†ã®ã‚¿ã‚¤ãƒãƒ¼ã ã‘æ›´æ–°
              document.getElementById('myPauseTimeLeft').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;

              // âœ… ç›¸æ‰‹ã«ã‚‚é€ä¿¡
              socket.emit('pause-time-update', { roomId, remainingPauseTime });
            } else {
              clearInterval(pauseInterval);
            }
          }, 1000);
        }


        function handlePauseStart() {
          isPaused = true;
          timerPaused = true;
          updatePauseStatusDisplay(null, true, false);
          startPauseCountdown();

          pauseBtn.disabled = true;       // â¸ï¸ ã¯æŠ¼ã›ãªã„ã‚ˆã†ã«
          resumeBtn.disabled = false;     // â–¶ï¸ ã¯æœ‰åŠ¹ã«ã™ã‚‹
        }

        function handlePauseEnd() {
          isPaused = false;
          timerPaused = false;
          updatePauseStatusDisplay(null, false, false);
          clearInterval(pauseInterval);

          resumeBtn.disabled = true;      // â–¶ï¸ ã‚’ç„¡åŠ¹ã«ã—ã¦
          if (remainingPauseTime > 0) {
            pauseBtn.disabled = false;    // â¸ï¸ ã‚’å†ã³æœ‰åŠ¹ã«
          }
        }

        socket.on('partner-paused', (partnerName) => {
          updatePauseStatusDisplay(partnerName, false, true);
        });

        socket.on('partner-resumed', () => {
          updatePauseStatusDisplay(null, false, false);
        });

        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');

        function lockPauseButton() {
          pauseBtn.disabled = true;
          resumeBtn.disabled = true;
        }


        function unlockPauseButton() {
          if (remainingPauseTime > 0) {
            pauseBtn.disabled = false;
          }
        }


        socket.on('partner-paused', (partnerName) => {
          timerPaused = true;
          updatePauseStatusDisplay(partnerName, false, true);
          lockPauseButton(); // â† ç›¸æ‰‹ãŒä¸€æ™‚åœæ­¢ä¸­ãªã®ã§è‡ªåˆ†ã¯æŠ¼ã›ãªã„
        });


        socket.on('partner-resumed', () => {
          timerPaused = false;
          updatePauseStatusDisplay(null, false, false);
          unlockPauseButton(); // â† ç›¸æ‰‹ãŒè§£é™¤ã—ãŸã®ã§è‡ªåˆ†ã‚‚æ“ä½œå¯èƒ½ã«
        });



        pauseBtn.addEventListener('click', () => {
          if (remainingPauseTime <= 0) return;
          socket.emit('pause', { roomId, username: "<%= user.username %>" });
          handlePauseStart();
          pauseBtn.style.display = 'none';
          resumeBtn.style.display = 'inline-block';
        });

        resumeBtn.addEventListener('click', () => {
          socket.emit('resume', roomId);
          handlePauseEnd();
          resumeBtn.style.display = 'none';
          pauseBtn.style.display = 'inline-block';
        });

        function validateBlockForm() {
          const reason = document.getElementById('reason');
          if (!reason.value) {
            alert("é€šå ±ç†ç”±ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
            return false;
          }
          return true;
        }

  //ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆ‡ã‚Šæ›¿ãˆ
  const micSelect = document.getElementById('micSelect');
  const speakerSelect = document.getElementById('speakerSelect');
  const remoteAudio = document.getElementById('remoteAudio');
  const speakerVolumeSlider = document.getElementById('speakerVolume');
  
  let currentStream;

  async function initDeviceSelectors() {
    try {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(d => d.kind === 'audioinput');
      const audioOutputs = devices.filter(d => d.kind === 'audiooutput');

      micSelect.innerHTML = '';
      speakerSelect.innerHTML = '';

      audioInputs.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `ãƒã‚¤ã‚¯ (${device.deviceId})`;
        micSelect.appendChild(option);
      });

      audioOutputs.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ (${device.deviceId})`;
        speakerSelect.appendChild(option);
      });

      // ä¿å­˜æ¸ˆã¿ã®ã‚‚ã®ã‚’é¸æŠ
      const savedMic = localStorage.getItem('preferredMic');
      const savedSpeaker = localStorage.getItem('preferredSpeaker');
      if (savedMic && micSelect.querySelector(`[value="${savedMic}"]`)) {
        micSelect.value = savedMic;
        await switchMic(savedMic); // åˆå›ã‹ã‚‰åæ˜ 
      }
      if (savedSpeaker && speakerSelect.querySelector(`[value="${savedSpeaker}"]`)) {
        speakerSelect.value = savedSpeaker;
        await switchSpeaker(savedSpeaker);
      }
    } catch (err) {
      console.error("ğŸ§ ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
    }
  }

  //éŸ³é‡èª¿æ•´
    speakerVolumeSlider.addEventListener('input', () => {
    remoteAudio.volume = parseFloat(speakerVolumeSlider.value);
  });

  // ğŸ¤ ãƒã‚¤ã‚¯åˆ‡ã‚Šæ›¿ãˆ
  async function switchMic(deviceId) {
    try {
      const newStream = await navigator.mediaDevices.getUserMedia({
        audio: { deviceId: { exact: deviceId } }
      });

      const newAudioTrack = newStream.getAudioTracks()[0];
      const sender = peer.getSenders().find(s => s.track.kind === 'audio');
      if (sender) {
        sender.replaceTrack(newAudioTrack);
      }

      // å¤ã„ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
      }

      currentStream = newStream;
    } catch (err) {
      console.error('ğŸ¤ ãƒã‚¤ã‚¯åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  // ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
  async function switchSpeaker(deviceId) {
    if (typeof remoteAudio.setSinkId === 'function') {
      try {
        await remoteAudio.setSinkId(deviceId);
        console.log('ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼å¤‰æ›´:', deviceId);
      } catch (err) {
        console.error('ğŸ”Š ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', err);
      }
    } else {
      console.warn('setSinkId æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™');
    }
  }

  micSelect.addEventListener('change', () => {
    const selected = micSelect.value;
    localStorage.setItem('preferredMic', selected);
    switchMic(selected);
  });

  speakerSelect.addEventListener('change', () => {
    const selected = speakerSelect.value;
    localStorage.setItem('preferredSpeaker', selected);
    switchSpeaker(selected);
  });

  initDeviceSelectors();



  </script>
  
</body>
</html>
