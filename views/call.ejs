<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°é€šè©±</title>
</head>

<body>
  <h1>é€šè©±ãƒ«ãƒ¼ãƒ : <%= roomId %></h1>
  <p id="status">éŸ³å£°é€šè©±ã‚’æº–å‚™ä¸­...</p>

  <!-- ãƒ¡ãƒ¢å…¥åŠ›æ¬„ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
<div id="noteSection" style="display: none; margin-top: 20px;">
    <h3>é€šè©±ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h3>
    <form id="noteForm" method="POST" action="/save-note">
      <textarea name="note" rows="5" cols="50" placeholder="æ°—ã¥ãã‚„æ”¹å–„ç‚¹ãªã©ã‚’æ›¸ã„ã¦ã­ï¼"></textarea><br>
      <input type="hidden" name="roomId" value="<%= roomId %>">
      <input type="hidden" name="partnerId" value="<%= partner._id %>">
      <button type="submit">ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹</button>
    </form>
    <button id="skipNoteBtn" style="margin-top: 10px;">ãƒ¡ãƒ¢ã‚’æ®‹ã•ãšçµ‚äº†</button>
  </div>


  <div id="timer" style="font-size: 24px; margin-bottom: 10px; color: green;">02:00</div>
  <p id="extensionInfo">å»¶é•·å¯èƒ½å›æ•°: 2å›</p>
  <p>å»¶é•·ã¯æ®‹ã‚Š30ç§’ã§ç›¸æ‰‹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¯èƒ½ã«ãªã‚Šã¾ã™ï¼</p>
  <button id="extendBtn" style="display: none;">å»¶é•·ã™ã‚‹</button>
 
  <h2>ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h2>

  <img src="/uploads/<%= partner.avatar || 'default.png' %>" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" style="width: 120px; height: 120px; border-radius: 50%; border: 2px solid #ccc; margin-bottom: 10px;">
  
  <ul>
    <li><strong>åå‰:</strong> <%= partner.username %></li>
    <li><strong>è¶£å‘³:</strong> <%= partner.hobbies || 'æœªè¨­å®š' %></li>
    <li><strong>ç›®çš„:</strong> <%= partner.purpose || 'æœªè¨­å®š' %></li>
    <li><strong>è‹±èªãƒ¬ãƒ™ãƒ«:</strong> <%= partner.level %></li>
  </ul>

  <div id="topicArea" style="display: none; margin-top: 20px;">
    <h3>ğŸ’¬ è©±é¡Œã‚«ãƒ¼ãƒ‰</h3>
    <p id="topicContent">è©±é¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <button id="changeTopicBtn">ä»–ã®è©±é¡Œã«å¤‰ãˆã‚‹</button>
  </div>
  <button id="showTopicBtn">è©±é¡Œã‚’é¸ã¶</button>

  <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
  <button id="endCallBtn" disabled style="padding: 10px 20px; background-color: crimson; color: white; border: none; border-radius: 5px; font-size: 16px;">
    é€šè©±ã‚’çµ‚äº†ã™ã‚‹
  </button>

  <!-- éŸ³å£°å‡ºåŠ› -->
  <audio id="remoteAudio" autoplay></audio>

  <script src="/socket.io/socket.io.js"></script>

  <script>

    
    const socket = io();
    const roomId = "<%= roomId %>";
    const userId = "<%= user._id %>";
  
    socket.emit('join-waiting', userId);
  
    const peer = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
  
    const endCallBtn = document.getElementById('endCallBtn');
    const timerDisplay = document.getElementById('timer');
    const noteSection = document.getElementById('noteSection');
    const statusEl = document.getElementById('status');
    const extendBtn = document.getElementById('extendBtn');

  
    let remaining = 120;
    let timerInterval;
    
  
  
    
    function endCall() {
      
      // è¡¨ç¤ºã‚’éè¡¨ç¤ºã«
      if (statusEl) statusEl.style.display = 'none';
      if (endCallBtn) endCallBtn.style.display = 'none';
      if (timerDisplay) timerDisplay.style.display = 'none';
      if (noteSection) noteSection.style.display = 'block';
  
      clearInterval(timerInterval);
  
      // éŸ³å£°é€ä¿¡åœæ­¢
      if (peer && peer.getSenders) {
        peer.getSenders().forEach(sender => {
          if (sender.track) sender.track.stop();
        });
      }

      socket.emit('force-end', roomId);
    }

    


  
    endCallBtn.addEventListener('click', endCall);
  
    function startTimer() {
      timerInterval = setInterval(() => {
        const min = String(Math.floor(remaining / 60)).padStart(2, '0');
        const sec = String(remaining % 60).padStart(2, '0');
        timerDisplay.textContent = `${min}:${sec}`;
  
        if (remaining === 30 && extensionCount < 2) {
            timerDisplay.style.color = "red";
            extendBtn.style.display = 'inline-block';
            extendBtn.disabled = false;
            extendBtn.textContent = 'å»¶é•·ã™ã‚‹';
            }

  
        if (remaining <= 0) {
          clearInterval(timerInterval);
          if (statusEl) {
            statusEl.textContent = 'ğŸ“ é€šè©±æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã—ã‚‡ã†ï¼';
            statusEl.style.color = 'black';
          }
          endCall(); // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—æ™‚ã«ã‚‚å…±é€šå‡¦ç†ã‚’å‘¼ã¶
        }
  
        remaining--;
      }, 1000);
    }
  
    socket.on('matched', (roomId) => {
      window.location.href = `/call/${roomId}`;
    });
  
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        stream.getTracks().forEach(track => peer.addTrack(track, stream));
  
        peer.ontrack = (event) => {
          document.getElementById('remoteAudio').srcObject = event.streams[0];
          if (statusEl) {
            statusEl.textContent = 'âœ… é€šè©±ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼';
            statusEl.style.color = 'green';
            statusEl.style.fontWeight = 'bold';
          }

      
          endCallBtn.disabled = false;
          startTimer();
        };
  
        socket.emit('join-room', roomId);
  
        socket.on('ready', async () => {
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit('offer', roomId, offer);
        });
  
        socket.on('offer', async (offer) => {
          await peer.setRemoteDescription(offer);
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        });
  
        socket.on('answer', async (answer) => {
          await peer.setRemoteDescription(answer);
        });
  
        socket.on('ice-candidate', async (candidate) => {
          if (candidate) {
            await peer.addIceCandidate(candidate);
          }
        });

        socket.on('force-end', () => {
            console.log("ğŸ“´ ç›¸æ‰‹ãŒé€šè©±ã‚’çµ‚äº†ã—ãŸãŸã‚ã€è‡ªåˆ†ã‚‚çµ‚äº†ã—ã¾ã™");
            endCall(); // è‡ªåˆ†å´ã§ã‚‚çµ‚äº†å‡¦ç†
        });
  
        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('ice-candidate', roomId, event.candidate);
          }
        };
      })
      .catch(err => {
        console.error("âŒ ãƒã‚¤ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      });

      const showTopicBtn = document.getElementById('showTopicBtn');
      const changeTopicBtn = document.getElementById('changeTopicBtn');
      const topicArea = document.getElementById('topicArea');
      const topicContent = document.getElementById('topicContent');

      const topics = [
        "é€±æœ«ã¯ä½•ã‚’ã—ã¦éã”ã™ã®ãŒå¥½ãï¼Ÿ",
        "æœ€è¿‘è¦‹ãŸæ˜ ç”»ã§é¢ç™½ã‹ã£ãŸã®ã¯ï¼Ÿ",
        "è‹±èªã‚’å­¦ã¶ãã£ã‹ã‘ã¯ï¼Ÿ",
        "ã‚‚ã—ã©ã“ã§ã‚‚ä½ã‚ã‚‹ãªã‚‰ã€ã©ã“ã‚’é¸ã¶ï¼Ÿ",
        "å­ã©ã‚‚ã®ã“ã‚ã®å¤¢ã¯ï¼Ÿ"
      ];

      function selectRandomTopic() {
        const topic = topics[Math.floor(Math.random() * topics.length)];
        socket.emit('topic-selected', { roomId, topic }); // âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§é€ä¿¡
      }

      // è©±é¡Œã‚’åˆã‚ã¦é¸ã¶ or å†é¸æŠ
      showTopicBtn.addEventListener('click', selectRandomTopic);
      changeTopicBtn.addEventListener('click', selectRandomTopic);

      // ç›¸æ‰‹ã¨è©±é¡Œã‚’å…±æœ‰
      socket.on('topic-selected', (topic) => {
        topicContent.textContent = topic;
        topicArea.style.display = 'block';
        showTopicBtn.style.display = 'none'; // è©±é¡Œé¸æŠå¾Œã¯éè¡¨ç¤ºã«
      });

   

        // å»¶é•·å‡¦ç†ï¼ˆ60ç§’è¿½åŠ ï¼‰
        let extensionCount = 0; // â† è¿½åŠ ï¼ˆåˆè¨ˆå»¶é•·å›æ•°ã‚’ç®¡ç†ï¼‰
        let isExtending = false;

        function extendCall() {
            if (isExtending || extensionCount >= 2) return;

            isExtending = true;
            console.log("ğŸŸ© extendCall() å®Ÿè¡Œï¼ ç¾åœ¨ã® extensionCount:", extensionCount);

            extensionCount++;
            remaining += 60;

            // extensionCount ãŒ 2 ã«é”ã—ãŸã¨ãã ã‘éè¡¨ç¤ºã«ã™ã‚‹
            if (extensionCount >= 2) {
                extendBtn.style.display = 'none';
            } else {
                extendBtn.style.display = 'inline-block';
                extendBtn.disabled = true;
                extendBtn.textContent = 'ç›¸æ‰‹ã®åŒæ„ã‚’å¾…ã£ã¦ã„ã¾ã™...';
            }


            statusEl.textContent = 'âœ… é€šè©±ãŒ1åˆ†å»¶é•·ã•ã‚Œã¾ã—ãŸ';
            statusEl.style.color = 'green';

            updateExtensionInfo(); // ğŸ”„ æ®‹ã‚Šå›æ•°ã®è¡¨ç¤ºã‚’æ›´æ–°

            extensionRequested = false;
            extensionReceived = false;

            setTimeout(() => {
                isExtending = false;
            }, 100);
        }

      document.getElementById('skipNoteBtn').addEventListener('click', () => {
        if (confirm("ãƒ¡ãƒ¢ã‚’æ®‹ã•ãšçµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) {
            window.location.href = '/dashboard';
        }
        });

          //å»¶é•·æ©Ÿèƒ½
        let extensionAgreed = false;
        let partnerAgreed = false;



        let extensionRequested = false;
        let extensionReceived = false;

        extendBtn.addEventListener('click', () => {
            if (extensionCount >= 2) return;

            // ğŸ§¹ ã“ã“ã§æ¯å›åˆæœŸåŒ–ï¼ˆå¤§äº‹ï¼ï¼‰
            extensionRequested = true;
            extensionReceived = false;

            extendBtn.disabled = true;
            extendBtn.textContent = 'ç›¸æ‰‹ã®åŒæ„ã‚’å¾…ã£ã¦ã„ã¾ã™...';

            socket.emit('request-extension', roomId);

        if (extensionReceived) {
            socket.emit('approve-extension', roomId); // ä¸¡æ–¹æŠ¼ã—ãŸã®ã§OKé€šçŸ¥
            extendCall();
        }
        });

        // ç›¸æ‰‹ã‹ã‚‰å»¶é•·ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå±Šã„ãŸæ™‚
        socket.on('extension-requested', () => {
        extensionReceived = true;

        if (extensionRequested) {
            socket.emit('approve-extension', roomId);
        } else {
            if (extensionCount < 2) {
            extendBtn.style.display = 'inline-block';
            extendBtn.disabled = false;
            extendBtn.textContent = 'é€šè©±ç›¸æ‰‹ãŒå»¶é•·ã‚’å¸Œæœ›ã—ã¦ã„ã¾ã™';
            }
        }
        });

        let extensionApprovals = 0;

        socket.on('extension-approved', () => {
        if (extensionApprovals >= extensionCount + 1) return;

        console.log("ğŸ“¥ extension-approved å—ä¿¡ï¼ extensionApprovals:", extensionApprovals, "extensionCount:", extensionCount);
        
        extensionApprovals++;
        extendCall();
        });


         // å»¶é•·å›æ•°è¡¨ç¤ºï¼ˆæœ€å¤§2å›ã¾ã§ï¼‰
        function updateExtensionInfo() {
        const remaining = 2 - extensionCount;
        document.getElementById('extensionInfo').textContent = `å»¶é•·å¯èƒ½å›æ•°: ${remaining}å›`;
        }

        // åˆæœŸè¡¨ç¤º
        updateExtensionInfo();



  </script>
  
</body>
</html>
