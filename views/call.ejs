<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°é€šè©±</title>
</head>

<!-- ãƒ¡ãƒ¢å…¥åŠ›æ¬„ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
<div id="noteSection" style="display: none; margin-top: 20px;">
    <h3>é€šè©±ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h3>
    <textarea id="noteText" rows="5" cols="50" placeholder="æ°—ã¥ãã‚„æ”¹å–„ç‚¹ãªã©ã‚’æ›¸ã„ã¦ã­ï¼"></textarea><br>
    <button id="saveNoteBtn">ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹</button>
  </div>


<body>
  <h1>é€šè©±ãƒ«ãƒ¼ãƒ : <%= roomId %></h1>
  <p id="status">éŸ³å£°é€šè©±ã‚’æº–å‚™ä¸­...</p>

  <div id="timer" style="font-size: 24px; margin-bottom: 10px; color: green;">02:00</div>

  <!-- çµ‚äº†ãƒœã‚¿ãƒ³ -->
  <button id="endCallBtn" disabled style="padding: 10px 20px; background-color: crimson; color: white; border: none; border-radius: 5px; font-size: 16px;">
    é€šè©±ã‚’çµ‚äº†ã™ã‚‹
  </button>

  <!-- éŸ³å£°å‡ºåŠ› -->
  <audio id="remoteAudio" autoplay></audio>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    console.log("ğŸ“² JavaScript ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™");

    const socket = io();
    const roomId = "<%= roomId %>";
    const userId = "<%= user._id %>";

    socket.emit('join-waiting', userId);

    const peer = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    });

    const endCallBtn = document.getElementById('endCallBtn');
    const timerDisplay = document.getElementById('timer');
    let remaining = 120;
    let timerInterval;

    // çµ‚äº†ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    endCallBtn.addEventListener('click', () => {
  // éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢
  peer.getSenders().forEach(sender => {
    if (sender.track) {
      sender.track.stop();
    }
  });

  // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
  clearInterval(timerInterval);

  // ãƒœã‚¿ãƒ³éè¡¨ç¤º
  endCallBtn.style.display = 'none';

  // ãƒ¡ãƒ¢ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
  const noteForm = document.createElement('form');
  noteForm.method = 'POST';
  noteForm.action = '/save-note';

  noteForm.innerHTML = `
    <h3>åçœãƒ¡ãƒ¢ã‚’æ®‹ãã†</h3>
    <textarea name="note" rows="5" cols="50" placeholder="ä»Šæ—¥ã®æ°—ã¥ãã‚„åçœç‚¹ãªã©..."></textarea>
    <input type="hidden" name="roomId" value="${roomId}">
    <button type="submit">ä¿å­˜</button>
  `;

  document.body.appendChild(noteForm);
});

    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
    const startTimer = () => {
      timerInterval = setInterval(() => {
        const min = String(Math.floor(remaining / 60)).padStart(2, '0');
        const sec = String(remaining % 60).padStart(2, '0');
        timerDisplay.textContent = `${min}:${sec}`;

        if (remaining <= 30) {
          timerDisplay.style.color = "red";
        }

        if (remaining <= 0) {
          clearInterval(timerInterval);

          // ãƒã‚¤ã‚¯åœæ­¢ï¼ˆéŸ³å£°é€ä¿¡åœæ­¢ï¼‰
            peer.getSenders().forEach(sender => {
                if (sender.track) sender.track.stop();
            });

            endCallBtn.style.display = 'none'; // çµ‚äº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('status').textContent = 'ğŸ“ é€šè©±æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã—ã‚‡ã†ï¼';
            document.getElementById('status').style.color = 'black';

            // ãƒ¡ãƒ¢æ¬„ã‚’è¡¨ç¤º
            document.getElementById('noteSection').style.display = 'block';

            return;
            
           //ãƒ¡ãƒ¢ã‚’æ®‹ã•ãšã«çµ‚äº†ã—ãŸã„å ´åˆã«å¿…è¦ã«ãªã‚‹ã‹ã‚‚ 
          //alert("é€šè©±æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸ");
          //window.location.href = "/dashboard";

        }

        remaining--;
      }, 1000);
    };

    socket.on('matched', (roomId) => {
      console.log("ğŸ” matched ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ â†’ /call ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ");
      window.location.href = `/call/${roomId}`;
    });

    socket.on('connect', () => {
      console.log("âœ… ã‚½ã‚±ãƒƒãƒˆæ¥ç¶šOKï¼", socket.id);
    });

    console.log("ğŸ“¡ ãƒ«ãƒ¼ãƒ ID: ", roomId);

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        stream.getTracks().forEach(track => peer.addTrack(track, stream));

        peer.ontrack = (event) => {
          console.log("ğŸ§ ç›¸æ‰‹ã®éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ãŒæ¥ãŸï¼");
          document.getElementById('remoteAudio').srcObject = event.streams[0];

          const statusEl = document.getElementById('status');
          if (statusEl) {
            statusEl.textContent = 'âœ… é€šè©±ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼';
            statusEl.style.color = 'green';
            statusEl.style.fontWeight = 'bold';
          }

          endCallBtn.disabled = false;
          startTimer();
        };

        socket.emit('join-room', roomId);

        socket.on('ready', async () => {
          console.log("ğŸš€ ç›¸æ‰‹ãŒå…¥å®¤ã—ãŸã®ã§ã€offer ã‚’é€ä¿¡ã—ã¾ã™");
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit('offer', roomId, offer);
        });

        socket.on('offer', async (offer) => {
          await peer.setRemoteDescription(offer);
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        });

        socket.on('answer', async (answer) => {
          await peer.setRemoteDescription(answer);
        });

        socket.on('ice-candidate', async (candidate) => {
          if (candidate) {
            await peer.addIceCandidate(candidate);
          }
        });

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('ice-candidate', roomId, event.candidate);
          }
        };
      })
      .catch(err => {
        console.error("âŒ ãƒã‚¤ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      });
  </script>
</body>
</html>
