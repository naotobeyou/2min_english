<!-- views/call.ejs -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°é€šè©±</title>
</head>
<body>
  <h1>é€šè©±ãƒ«ãƒ¼ãƒ : <%= roomId %></h1>
  <p>éŸ³å£°é€šè©±ã‚’æº–å‚™ä¸­...</p>

  <!-- éŸ³å£°å‡ºåŠ› -->
  <audio id="remoteAudio" autoplay></audio>

  <!-- Socket.IOã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- JavaScript æœ¬ä½“ -->
  <script>
    console.log("ğŸ“² JavaScript ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™");

    const socket = io();
    const roomId = "<%= roomId %>";
    const userId = "<%= user._id %>";
    socket.emit('join-waiting', userId);
    const peer = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    });

    socket.on('matched', (roomId) => {
    console.log("ğŸ” matched ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ â†’ /call ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ");
    window.location.href = `/call/${roomId}`;
  });

    socket.on('connect', () => {
      console.log("âœ… ã‚½ã‚±ãƒƒãƒˆæ¥ç¶šOKï¼", socket.id);
    });

    console.log("ğŸ“¡ ãƒ«ãƒ¼ãƒ ID: ", roomId);

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        stream.getTracks().forEach(track => peer.addTrack(track, stream));

        peer.ontrack = (event) => {
          console.log("ğŸ§ ç›¸æ‰‹ã®éŸ³å£°ãƒˆãƒ©ãƒƒã‚¯ãŒæ¥ãŸï¼");
          document.getElementById('remoteAudio').srcObject = event.streams[0];
        };

        socket.emit('join-room', roomId);

        socket.on('ready', async () => {
          console.log("ğŸš€ ç›¸æ‰‹ãŒå…¥å®¤ã—ãŸã®ã§ã€offer ã‚’é€ä¿¡ã—ã¾ã™");
          const offer = await peer.createOffer();
          await peer.setLocalDescription(offer);
          socket.emit('offer', roomId, offer);
        });

        socket.on('offer', async (offer) => {
          await peer.setRemoteDescription(offer);
          const answer = await peer.createAnswer();
          await peer.setLocalDescription(answer);
          socket.emit('answer', roomId, answer);
        });

        socket.on('answer', async (answer) => {
          await peer.setRemoteDescription(answer);
        });

        socket.on('ice-candidate', async (candidate) => {
          if (candidate) {
            await peer.addIceCandidate(candidate);
          }
        });

        peer.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('ice-candidate', roomId, event.candidate);
          }
        };
      })
      .catch(err => {
        console.error("âŒ ãƒã‚¤ã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      });
  </script>
</body>
</html>
